{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>LateBench</h1>
            <p>Mathematical Reasoning Error Analysis</p>
        </div>
        
        <!-- Statistics -->
        <div class="stats-panel">
            <h3>Statistics</h3>
            <div class="stat-item">
                <span class="number">{{ stats.total_examples }}</span>
                <span class="label">Total Problems</span>
            </div>
            <div class="stat-item">
                <span class="number">{{ stats.unique_error_types }}</span>
                <span class="label">Error Types</span>
            </div>
            <div class="stat-item">
                <span class="number">{{ "%.1f"|format(stats.avg_steps) }}</span>
                <span class="label">Avg Steps</span>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filter-panel">
            <h3>Filters</h3>
            
            <div class="filter-group">
                <label for="error-type-filter">Error Type:</label>
                <select id="error-type-filter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                    {% for error_type in error_types %}
                    <option value="{{ error_type }}">{{ error_type.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="step-range">Steps:</label>
                <div class="range-inputs">
                    <input type="number" id="min-steps" placeholder="Min" min="1" onchange="applyFilters()">
                    <input type="number" id="max-steps" placeholder="Max" min="1" onchange="applyFilters()">
                </div>
            </div>
            
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="has-critic-filter" onchange="applyFilters()">
                    Has Critic Analysis
                </label>
            </div>
            
            <button onclick="clearFilters()" class="clear-filters-btn">Clear Filters</button>
        </div>
        
        <!-- Problem List -->
        <div class="problem-list">
            <h3>Problems <span id="problem-count">({{ examples|length }})</span></h3>
            <div id="problems-container">
                {% for example in examples %}
                <div class="problem-card" data-id="{{ example.id }}" 
                     onclick="selectExample({{ example.id }})"
                     {% if current_example and example.id == current_example.id %}class="problem-card selected"{% endif %}>
                    <div class="problem-title">{{ example.title }}</div>
                    <div class="problem-meta">
                        <span class="error-type">{{ example.error_info.type.replace('_', ' ').title() }}</span>
                        <span class="step-info">{{ example.original_solution.num_steps }} steps</span>
                    </div>
                    <div class="problem-status">
                        {% if example.critic_result %}
                        <span class="critic-badge">✓ Analyzed</span>
                        {% endif %}
                        <span class="error-step">Error: Step {{ example.error_info.step }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        {% if current_example %}
        <!-- Actions Bar -->
        <div class="actions-bar">
            <button onclick="previousExample()" id="prev-btn">← Previous</button>
            <button onclick="nextExample()" id="next-btn">Next →</button>
            <button onclick="runCritic()" id="critic-btn" class="critic-btn">
                <span id="critic-btn-text">Run Critic</span>
                <span id="critic-spinner" class="spinner" style="display: none;"></span>
            </button>
            <button onclick="exportExample()" class="export-btn">Export</button>
            <select onchange="jumpToExample(this.value)" id="example-selector">
                <option value="">Jump to Problem...</option>
                {% for ex in examples %}
                <option value="{{ ex.id }}" {% if current_example.id == ex.id %}selected{% endif %}>
                    {{ ex.title }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Four Panel Layout -->
        <div class="content-grid">
            <!-- Panel 1: Problem Statement -->
            <div class="panel problem-panel">
                <h3>Problem Statement</h3>
                <div class="panel-content">
                    <div class="math-content">{{ current_example.problem }}</div>
                    <div class="problem-meta">
                        <span class="source-badge">Source: {{ current_example.source }}</span>
                        <span class="difficulty-badge">{{ current_example.original_solution.num_steps }} Steps</span>
                    </div>
                </div>
            </div>
            
            <!-- Panel 2: Original Solution -->
            <div class="panel solution-panel original">
                <h3>Correct Solution</h3>
                <div class="panel-content">
                    <div class="steps-list">
                        {% for step in current_example.original_solution.steps %}
                        <div class="step step-correct">
                            <div class="step-number">{{ step.number }}</div>
                            <div class="step-content">{{ step.content }}</div>
                            <div class="step-status">✓</div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="final-answer correct">
                        <strong>Answer:</strong> {{ current_example.original_solution.answer }}
                    </div>
                </div>
            </div>
            
            <!-- Panel 3: Modified Solution -->
            <div class="panel solution-panel modified">
                <h3>Solution with Injected Error</h3>
                <div class="panel-content">
                    <div class="steps-list">
                        {% for step in current_example.modified_solution.steps %}
                        <div class="step 
                                    {% if step.is_error %}step-error{% elif step.is_modified %}step-modified{% else %}step-unchanged{% endif %}">
                            <div class="step-number">{{ step.number }}</div>
                            <div class="step-content">{{ step.content }}</div>
                            <div class="step-status">
                                {% if step.is_error %}⚠️{% elif step.is_modified %}⚡{% else %}✓{% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="final-answer incorrect">
                        <strong>Answer:</strong> {{ current_example.modified_solution.answer }}
                    </div>
                    
                    <div class="error-info">
                        <h4>Error Details</h4>
                        <div class="error-detail">
                            <strong>Type:</strong> {{ current_example.error_info.type.replace('_', ' ').title() }}
                        </div>
                        <div class="error-detail">
                            <strong>Step:</strong> {{ current_example.error_info.step }}
                        </div>
                        <div class="error-detail">
                            <strong>What Changed:</strong> 
                            <p>{{ current_example.error_info.what_changed }}</p>
                        </div>
                        <div class="error-detail">
                            <strong>Why Incorrect:</strong>
                            <p>{{ current_example.error_info.why_incorrect }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel 4: Critic Evaluation -->
            <div class="panel critic-panel">
                <h3>Critic Analysis</h3>
                <div class="panel-content" id="critic-content">
                    {% if current_example.critic_result %}
                    <div class="critic-result">
                        <div class="conclusion {% if current_example.critic_result.has_errors %}has-errors{% else %}no-errors{% endif %}">
                            <strong>Conclusion:</strong> 
                            {% if current_example.critic_result.has_errors %}Errors Found{% else %}No Errors{% endif %}
                        </div>
                        
                        {% if current_example.critic_result.has_errors %}
                        <div class="detected-errors">
                            <h4>Detected Issues:</h4>
                            {% for step_num in current_example.critic_result.error_steps %}
                            <div class="error-item">
                                <strong>Step {{ step_num }}:</strong>
                                <p>{{ current_example.critic_result.explanations.get(step_num|string, 'No explanation provided') }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if current_example.critic_analysis %}
                        <div class="evaluation-summary">
                            <h4>Performance Analysis:</h4>
                            {% if current_example.critic_analysis.correct_detection %}
                            <div class="accuracy-indicator success">
                                ✅ Correctly identified error in step {{ current_example.error_info.step }}
                            </div>
                            {% elif current_example.critic_analysis.missed_error %}
                            <div class="accuracy-indicator error">
                                ❌ Missed error in step {{ current_example.error_info.step }}
                            </div>
                            {% endif %}
                            
                            {% if current_example.critic_analysis.false_positives %}
                            <div class="accuracy-indicator warning">
                                ⚠️ False positives in steps: {{ current_example.critic_analysis.false_positives|join(', ') }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="critic-meta">
                            <small>
                                Model: {{ current_example.critic_result.model_used }} | 
                                Time: {{ "%.2f"|format(current_example.critic_result.processing_time) }}s
                            </small>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-critic-result">
                        <p>No critic analysis available yet.</p>
                        <p>Click "Run Critic" to evaluate this solution.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <h2>No Example Selected</h2>
            <p>Select an example from the sidebar to begin analysis.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Store current example ID
let currentExampleId = {{ current_example.id if current_example else 'null' }};
let allExamples = {{ examples|tojson }};
let currentFilter = {};

// Navigation functions
function selectExample(exampleId) {
    window.location.href = `/example/${exampleId}`;
}

function previousExample() {
    const currentIndex = allExamples.findIndex(ex => ex.id === currentExampleId);
    if (currentIndex > 0) {
        selectExample(allExamples[currentIndex - 1].id);
    }
}

function nextExample() {
    const currentIndex = allExamples.findIndex(ex => ex.id === currentExampleId);
    if (currentIndex < allExamples.length - 1) {
        selectExample(allExamples[currentIndex + 1].id);
    }
}

function jumpToExample(exampleId) {
    if (exampleId) {
        selectExample(parseInt(exampleId));
    }
}

// Critic evaluation
async function runCritic() {
    if (!currentExampleId) return;
    
    const btn = document.getElementById('critic-btn');
    const btnText = document.getElementById('critic-btn-text');
    const spinner = document.getElementById('critic-spinner');
    
    // Show loading state
    btn.disabled = true;
    btnText.textContent = 'Running...';
    spinner.style.display = 'inline-block';
    
    try {
        const response = await fetch(`/api/run_critic/${currentExampleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload page to show results
            window.location.reload();
        } else {
            alert('Error running critic: ' + result.error);
        }
    } catch (error) {
        alert('Error running critic: ' + error.message);
    } finally {
        // Reset button state
        btn.disabled = false;
        btnText.textContent = 'Run Critic';
        spinner.style.display = 'none';
    }
}

// Export function
function exportExample() {
    if (!currentExampleId) return;
    window.open(`/export/${currentExampleId}`, '_blank');
}

// Filtering functions
async function applyFilters() {
    const errorType = document.getElementById('error-type-filter').value;
    const minSteps = document.getElementById('min-steps').value;
    const maxSteps = document.getElementById('max-steps').value;
    const hasCritic = document.getElementById('has-critic-filter').checked;
    
    const params = new URLSearchParams();
    if (errorType !== 'all') params.append('error_type', errorType);
    if (minSteps) params.append('min_steps', minSteps);
    if (maxSteps) params.append('max_steps', maxSteps);
    if (hasCritic) params.append('has_critic', 'true');
    
    try {
        const response = await fetch(`/api/filter?${params}`);
        const data = await response.json();
        
        updateProblemList(data.examples);
        document.getElementById('problem-count').textContent = `(${data.count})`;
    } catch (error) {
        console.error('Error applying filters:', error);
    }
}

function clearFilters() {
    document.getElementById('error-type-filter').value = 'all';
    document.getElementById('min-steps').value = '';
    document.getElementById('max-steps').value = '';
    document.getElementById('has-critic-filter').checked = false;
    applyFilters();
}

function updateProblemList(examples) {
    const container = document.getElementById('problems-container');
    container.innerHTML = '';
    
    examples.forEach(example => {
        const card = document.createElement('div');
        card.className = 'problem-card' + (example.id === currentExampleId ? ' selected' : '');
        card.setAttribute('data-id', example.id);
        card.onclick = () => selectExample(example.id);
        
        card.innerHTML = `
            <div class="problem-title">${example.title}</div>
            <div class="problem-meta">
                <span class="error-type">${example.error_info.type.replace(/_/g, ' ')}</span>
                <span class="step-info">${example.original_solution.num_steps} steps</span>
            </div>
            <div class="problem-status">
                ${example.critic_result ? '<span class="critic-badge">✓ Analyzed</span>' : ''}
                <span class="error-step">Error: Step ${example.error_info.step}</span>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// Trigger MathJax rendering after page load
window.addEventListener('load', function() {
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise().catch(err => console.log('MathJax error:', err));
    }
});
</script>
{% endblock %}